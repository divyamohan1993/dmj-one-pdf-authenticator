<!doctype html>
<html lang="en"><head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard · dmj.one</title>
  <link rel="shortcut icon" href="//dmj.one/logo.png">
  <link rel="fluid-icon" href="//dmj.one//logo.png">
  <link rel="apple-touch-icon" href="//dmj.one//logo.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet" />
  <style>
    body{background:#fbfcfe}
    .card{border:1px solid #edf0f3}
    .dropzone{border:1.5px dashed #cfd6df;border-radius:.75rem;padding:1.25rem;background:#fff}
    .dropzone.drag{background:#f5f9ff;border-color:#91b8ff}
    .hash{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.85rem;background:#f6f7f9;border:1px solid #edf0f3;border-radius:.4rem;padding:.25rem .4rem}
    .status-chip{font-size:.85rem}
    #toast{position:fixed;right:16px;bottom:16px;z-index:9999;min-width:260px;display:none}
    #toast.show{display:block}
    #liveRegion{position:absolute;left:-10000px;width:1px;height:1px;overflow:hidden}
  </style>
</head>
<body>
  <div id="liveRegion" aria-live="polite"></div>
  <nav class="navbar navbar-expand-lg bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="#"><i class="bi-shield-check me-2" style="color:#0d6efd"></i>dmj.one Admin</a>
      <form method="post" action="{{ADMIN_PATH}}/logout" class="ms-auto"><button class="btn btn-outline-secondary"><i class="bi-box-arrow-right me-2"></i>Logout</button></form>
    </div>
  </nav>

  <main class="container py-4">
    <div class="row g-4">
      <div class="col-lg-5">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="h5 d-flex align-items-center"><i class="bi-pen me-2 text-primary"></i>Sign a new PDF</h2>
            <div id="dz" class="dropzone mt-3 text-secondary text-center">
              <div class="small">
                <i class="bi-cloud-arrow-up"></i>
                Drag & drop PDF here or
                <label for="filePick" class="link-primary" style="cursor:pointer">browse</label>
                <input id="filePick" type="file" class="d-none" accept="application/pdf" />
              </div>
            </div>
            <div class="mt-3">
              <label class="form-label">Optional metadata (JSON)</label>
              <input id="meta" class="form-control" placeholder='{"orderId":"123","user":"alice"}'>
            </div>
            <div class="d-grid mt-3 d-none"><button id="signBtn" class="btn btn-primary" disabled><i class="bi-check2-square me-2"></i>Sign & Download</button></div>
            <div class="progress mt-3 d-none" id="prog"><div class="progress-bar progress-bar-striped progress-bar-animated" style="width:100%"></div></div>
            <div class="form-text mt-2">Documents are signed by dmj.one and re‑verified before storing. Bundle includes the Trust Kit.</div>
          </div>
        </div>
      </div>

      <div class="col-lg-7">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
              <h2 class="h5 d-flex align-items-center mb-0"><i class="bi-files me-2 text-primary"></i>Issued documents</h2>
              <input id="q" class="form-control form-control-sm" style="max-width:220px" placeholder="Filter by SHA…">
            </div>
            <div class="table-responsive mt-3">
              <table class="table align-middle table-hover mb-0">
                <thead><tr><th>SHA‑256</th><th>Signed</th><th>Status</th><th class="text-end">Action</th></tr></thead>
                <tbody id="tbody">
                  <tr><td colspan="4" class="text-secondary">Loading…</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="toast" class="alert alert-primary shadow-sm" role="status"></div>

  <script nonce="__CSP_NONCE__">
    const AP = "{{ADMIN_PATH}}"; // dynamic admin base path
    const toast = (msg, kind='primary') => {
      const t = document.getElementById('toast'); 
      t.className = 'alert alert-' + kind + ' shadow-sm'; 
      t.textContent = msg; t.classList.add('show');
      document.getElementById('liveRegion').textContent = msg; // aria-live
      setTimeout(()=>t.classList.remove('show'), 2200);
    };

    // ------- Table (load + filter + revoke) — unchanged -------
    let rows = [];
    async function loadRows(){
      const res = await fetch(AP+'?json=1', {headers:{'Accept':'application/json'}});      
      if(!res.ok){ toast('Failed to load documents','danger'); return; }
      const data = await res.json();
      rows = (data.documents||[]);
      renderRows();
    }
    function renderRows(){
      const q = (document.getElementById('q').value || '').toLowerCase().trim();
      const tb = document.getElementById('tbody');
      const fmt = ts => ts ? new Date(ts*1000).toISOString().replace('T',' ').replace(/\..+/, '') : '';
      const view = rows.filter(r => !q || r.sha.includes(q));
      tb.innerHTML = view.map(r=>{
        const active = !r.revoked_at;
        const chip = active ? '<span class="badge text-bg-success status-chip">Active</span>'
                            : '<span class="badge text-bg-danger status-chip">Revoked</span>';
        const btn = active ? '<button class="btn btn-sm btn-outline-danger revoke" data-sha="'+r.sha+'"><i class="bi-x-circle me-1"></i>Revoke</button>'
                           : '<button class="btn btn-sm btn-outline-secondary" disabled>Revoked</button>';
        return '<tr>' +
          '<td><span class="hash" title="'+r.sha+'">'+r.sha.slice(0,12)+'…'+r.sha.slice(-12)+'</span></td>' +
          '<td>'+fmt(r.signed_at)+'</td>' +
          '<td>'+chip+'</td>' +
          '<td class="text-end">'+btn+'</td>' +
        '</tr>';
      }).join('') || '<tr><td colspan="4" class="text-secondary">No documents</td></tr>';
    }
    document.getElementById('q').addEventListener('input', renderRows);
    document.getElementById('tbody').addEventListener('click', async (e)=>{
      const b = e.target.closest('button.revoke'); if(!b) return;
      const sha = b.getAttribute('data-sha');
      const fd = new FormData(); fd.set('sha', sha);      
      const res = await fetch(AP+'/revoke', {method:'POST', body:fd, headers:{'Accept':'application/json'}});
      if(!res.ok){ toast('Revoke failed','danger'); return; }
      const r = await res.json();
      toast('Revoked '+sha.slice(0,8)+'…','warning');
      const row = rows.find(x=>x.sha===sha); if(row){ row.revoked_at = r.revoked_at || Math.floor(Date.now()/1000); }
      renderRows();
    });

    // ------- Signer (auto-process) -------
    const dz   = document.getElementById('dz');
    const fp   = document.getElementById('filePick');
    const meta = document.getElementById('meta');
    const btn  = document.getElementById('signBtn');
    const prog = document.getElementById('prog');

    let file = null;
    const isPDF = f => f && (f.type === 'application/pdf' || /\.pdf$/i.test(f.name||'')); // NEW

    // Reusable signer — used by auto-flow AND the button
    async function signNow(){ // CHANGED (extracted from old btn handler)
      if(!file) return;
      prog.classList.remove('d-none');
      btn.disabled = true;
      try{
        const fd = new FormData();
        fd.set('file', file, file.name);
        const m = (meta.value||'').trim(); if(m) fd.set('meta', m); // uses whatever is in "Optional metadata" right now
        
        const res = await fetch(AP+'/sign', { method:'POST', body:fd });
        if(!res.ok){ const t = await res.text(); throw new Error(t||'sign error'); }

        const disp  = res.headers.get('content-disposition') || '';
        const match = /filename="?([^"]+)"?/i.exec(disp);
        const name  = match ? match[1] : ('signed-'+(file.name||'document')+(res.headers.get('content-type')?.includes('zip')?'.zip':''));
        const blob  = await res.blob();
        const url   = URL.createObjectURL(blob);
        const a     = Object.assign(document.createElement('a'), { href:url, download:name });
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
        toast('Signed & downloaded','success');
        loadRows(); // refresh issued list
      }catch(e){
        toast('Signing failed','danger');
      }finally{
        prog.classList.add('d-none');
        btn.disabled = false;
        file = null;
      }
    }

    // Set & auto-sign immediately
    const setFile = f => { // CHANGED (auto-trigger)
      if(!isPDF(f)){ toast('Please select a PDF','warning'); return; }
      file = f;
      toast('Processing '+(f?.name||'document')+'…');
      // no need to wait — start right away
      void signNow(); // NEW
    };

    // Drag & drop
    ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev, e=>{e.preventDefault(); dz.classList.add('drag');}));
    ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev, e=>{e.preventDefault(); dz.classList.remove('drag');}));
    dz.addEventListener('drop', e=>{
      const f = e.dataTransfer.files?.[0];
      if(f) setFile(f); // CHANGED: auto process on drop
    });

    // File picker
    fp.addEventListener('change', ()=>{
      const f = fp.files?.[0];
      if(f) setFile(f);     // CHANGED: auto process on select
      fp.value = '';        // keep this so selecting the same file later retriggers "change"  // NEW
    });

    // REMOVE this line — the label already activates the input and this can cause awkward UX
    // dz.querySelector('label').addEventListener('click', ()=>fp.click());  // DELETED

    // Keep button as a fallback/manual trigger
    btn.addEventListener('click', signNow); // CHANGED

    // init
    loadRows();
  </script>

</body></html>